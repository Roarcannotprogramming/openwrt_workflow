name: Delete Old Build Artifacts
on:
  workflow_dispatch:
  schedule:
    - cron: "0 21 * * *"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          echo "Current run ID: ${{ github.run_id }}"
          echo "Cutoff date: $(date -d '-7 day' -Iseconds)"

          # 删除 7 天前的 runs（排除当前 run）
          gh run list --limit 200 --json databaseId,createdAt \
            | jq -r --arg current "${{ github.run_id }}" \
                    --arg cutoff "$(date -d '-7 day' -Iseconds)" \
              '.[] | select(.createdAt < $cutoff and (.databaseId | tostring) != $current) | .databaseId' \
            | while read -r id; do
                [ -z "$id" ] && continue
                echo "Deleting old run: $id"
                gh run delete "$id" --repo "$GH_REPO" || true
              done

      - name: Cleanup this workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # 删除本工作流的旧 runs（保留最近 5 个）
          gh run list --workflow "delete_old.yml" --limit 100 --json databaseId \
            | jq -r '.[5:] | .[].databaseId' \
            | while read -r id; do
                [ -z "$id" ] && continue
                echo "Deleting cleanup workflow run: $id"
                gh run delete "$id" --repo "$GH_REPO" || true
              done
